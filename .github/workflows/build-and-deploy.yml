name: Deploy PR to Azure VM

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [ main ]
  workflow_dispatch:

env:
  DEPLOY_PATH: /home/${{ secrets.AZURE_VM_USERNAME }}/Github-App-Demo

jobs:
  # Job 1: Build and test backend
  build-backend:
    name: Build Backend
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha || github.sha }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: backend/package-lock.json

      - name: Install backend dependencies
        working-directory: backend
        run: npm ci

      - name: Type check backend
        working-directory: backend
        run: npx tsc --noEmit

      - name: Build backend
        working-directory: backend
        run: npm run build

      - name: Backend build summary
        if: success()
        run: echo "âœ… Backend build successful!"

  # Job 2: Build and test frontend
  build-frontend:
    name: Build Frontend
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha || github.sha }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install frontend dependencies
        working-directory: frontend
        run: npm install --legacy-peer-deps

      - name: Type check frontend
        working-directory: frontend
        run: npx tsc -b

      - name: Build frontend
        working-directory: frontend
        run: npm run build

      - name: Frontend build summary
        if: success()
        run: echo "âœ… Frontend build successful!"

  # Job 3: Deploy
  deploy:
    name: Deploy 
    runs-on: ubuntu-latest
    # needs: [build-backend, build-frontend]
    
    steps:
      - name: Checkout PR code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha || github.sha }}

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.AZURE_VM_SSH_KEY }}" > ~/.ssh/azure_vm_key
          chmod 600 ~/.ssh/azure_vm_key
          ssh-keyscan -H ${{ secrets.AZURE_VM_HOST }} >> ~/.ssh/known_hosts

      - name: Test SSH Connection
        run: |
          ssh -i ~/.ssh/azure_vm_key \
            -o StrictHostKeyChecking=no \
            -p ${{ secrets.AZURE_VM_PORT || 22 }} \
            ${{ secrets.AZURE_VM_USERNAME }}@${{ secrets.AZURE_VM_HOST }} \
            "echo 'SSH connection successful'"

      - name: Create deployment directory if not exists
        run: |
          ssh -i ~/.ssh/azure_vm_key \
            -p ${{ secrets.AZURE_VM_PORT || 22 }} \
            ${{ secrets.AZURE_VM_USERNAME }}@${{ secrets.AZURE_VM_HOST }} \
            "mkdir -p /home/${{ secrets.AZURE_VM_USERNAME }}/Github-App-Demo"

      - name: Sync PR code to Azure VM
        run: |
          rsync -avz --delete \
            -e "ssh -i ~/.ssh/azure_vm_key -p ${{ secrets.AZURE_VM_PORT || 22 }}" \
            --exclude='.git' \
            --exclude='node_modules' \
            --exclude='dist' \
            --exclude='build' \
            --exclude='.env' \
            --exclude='.DS_Store' \
            --exclude='*.log' \
            ./ ${{ secrets.AZURE_VM_USERNAME }}@${{ secrets.AZURE_VM_HOST }}:/home/${{ secrets.AZURE_VM_USERNAME }}/Github-App-Demo/

      - name: Deploy PR application
        run: |
          ssh -i ~/.ssh/azure_vm_key \
            -p ${{ secrets.AZURE_VM_PORT || 22 }} \
            ${{ secrets.AZURE_VM_USERNAME }}@${{ secrets.AZURE_VM_HOST }} << EOF
          set -e
          cd /home/${{ secrets.AZURE_VM_USERNAME }}/Github-App-Demo
          
          echo "ðŸ“¦ Stopping existing containers..."
          docker-compose down || true
          
          echo "ðŸ”¨ Building and starting containers from PR..."
          docker-compose up --build -d
          
          echo "â³ Waiting for services to be healthy..."
          sleep 10
          
          echo "âœ… PR Deployment complete!"
          docker-compose ps
          EOF

      - name: Verify deployment
        run: |
          ssh -i ~/.ssh/azure_vm_key \
            -p ${{ secrets.AZURE_VM_PORT || 22 }} \
            ${{ secrets.AZURE_VM_USERNAME }}@${{ secrets.AZURE_VM_HOST }} << EOF
          set -e
          cd /home/${{ secrets.AZURE_VM_USERNAME }}/Github-App-Demo
          
          echo "ðŸ” Checking backend health..."
          for i in {1..30}; do
            if curl -f http://localhost:5000/health > /dev/null 2>&1; then
              echo "âœ… Backend is healthy!"
              break
            fi
            if [ \$i -eq 30 ]; then
              echo "âŒ Backend health check failed"
              docker-compose logs backend
              exit 1
            fi
            sleep 2
          done
          
          echo "ðŸ” Checking frontend..."
          if curl -f http://localhost:3000 > /dev/null 2>&1; then
            echo "âœ… Frontend is accessible!"
          else
            echo "âš ï¸  Frontend might need more time to start"
          fi
          EOF

      - name: Cleanup SSH key
        if: always()
        run: |
          rm -f ~/.ssh/azure_vm_key

      - name: Comment PR with deployment info
        if: success() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `### âœ… PR Deployed Successfully! ðŸš€
              
              **Live Preview URLs:**
              - ðŸŒ Frontend: http://${{ secrets.AZURE_VM_HOST }}:3000
              - ðŸ”§ Backend API: http://${{ secrets.AZURE_VM_HOST }}:5000
              - ðŸ’š Health Check: http://${{ secrets.AZURE_VM_HOST }}:5000/health
              
              **Deployment Info:**
              - Branch: \`${{ github.head_ref }}\`
              - Commit: \`${{ github.event.pull_request.head.sha }}\`
              
              ðŸ§ª **Ready for testing!** The application is now running with your PR changes.
              
              âš ï¸ **Note:** This deployment will be overwritten by the next PR deployment.`
            })

      - name: Deployment summary
        if: success()
        run: |
          echo "### âœ… Deployment Successful! ðŸš€" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Application URLs:**" >> $GITHUB_STEP_SUMMARY
          echo "- Frontend: http://${{ secrets.AZURE_VM_HOST }}:3000" >> $GITHUB_STEP_SUMMARY
          echo "- Backend API: http://${{ secrets.AZURE_VM_HOST }}:5000" >> $GITHUB_STEP_SUMMARY
          echo "- Health Check: http://${{ secrets.AZURE_VM_HOST }}:5000/health" >> $GITHUB_STEP_SUMMARY

      - name: Deployment failed
        if: failure()
        run: |
          echo "### âŒ Deployment Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Please check the logs above for details." >> $GITHUB_STEP_SUMMARY
          echo "You can also SSH into the VM to investigate:" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "ssh ${{ secrets.AZURE_VM_USERNAME }}@${{ secrets.AZURE_VM_HOST }}" >> $GITHUB_STEP_SUMMARY
          echo "cd ~/Github-App-Demo" >> $GITHUB_STEP_SUMMARY
          echo "docker-compose logs" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

